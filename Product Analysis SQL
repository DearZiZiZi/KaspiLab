/* 1) –†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ DAU —Å–µ—Ä–≤–∏—Å–∞ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã (–∫–æ–Ω—Ç–∞–∫—Ç–æ–º —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ ‚Äú–ß–∞—Ç‚Äù –∏–ª–∏ ‚Äú–ü–æ–∑–≤–æ–Ω–∏—Ç—å‚Äù) 14 –∞–≤–≥—É—Å—Ç–∞ 2023 –≥–æ–¥–∞.*/
WITH DAU AS (
    SELECT COUNT(DISTINCT searcher_uid) AS DAU
    FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
    WHERE DATE(event_ts) = '2023-08-14'
),
Contacts AS (
    SELECT COUNT(*) AS contacts
    FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
    WHERE DATE(event_ts) = '2023-08-14'
    AND event_name = 'opened_chat' OR event_name = 'viewed_phone_num'
)
SELECT DAU, Contacts
FROM DAU, Contacts;

/* 2) –†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –¥–æ–ª—é –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ‚Äú–ß–∞—Ç‚Äù –∏ –∫–Ω–æ–ø–∫—É ‚Äú–ü–æ–∑–≤–æ–Ω–∏—Ç—å‚Äù –∑–∞ 14 –∞–≤–≥—É—Å—Ç–∞ 2023 –≥–æ–¥–∞.*/
--–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é –¥–æ–ª—é –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∑–∞ –¥–µ–Ω—å - 530,465

SELECT COUNT(searcher_uid) AS All_users_during_theday 
FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
WHERE DATE(event_ts) = '2023-08-14'

--–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ‚Äú–ß–∞—Ç‚Äù –∏ –∫–Ω–æ–ø–∫—É ‚Äú–ü–æ–∑–≤–æ–Ω–∏—Ç—å‚Äù - 12,360

SELECT COUNT(searcher_uid) AS Users_using_chatorcall 
FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
WHERE DATE(event_ts) = '2023-08-14'
    AND event_name IN ('opened_chat', 'viewed_phone_num');

-- –í —Ç–µ—Ö –∑–∞–¥–∞–Ω–∏–∏ –Ω—É–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–∞–∑–¥–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ "—á–∞—Ç–∞" –∏ "–ø–æ–∑–≤–æ–Ω–∏—Ç—å"
--4134 –¥–ª—è —á–∞—Ç–∞
SELECT COUNT(searcher_uid) AS Users_using_chatorcall 
FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
WHERE DATE(event_ts) = '2023-08-14'
    AND event_name ='opened_chat';
-- 8226 –¥–ª—è –ø–æ–∑–≤–æ–Ω–∏—Ç—å
SELECT COUNT(searcher_uid) AS Users_using_chatorcall 
FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
WHERE DATE(event_ts) = '2023-08-14'
    AND event_name = 'viewed_phone_num';

--–ò—Ç–æ–≥–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
WITH DailyUsers AS (
    SELECT 
        COUNT(searcher_uid) AS All_users_during_theday,
        COUNT(CASE WHEN event_name = 'opened_chat' THEN searcher_uid END) AS Users_using_chat,
        COUNT(CASE WHEN event_name = 'viewed_phone_num' THEN searcher_uid END) AS Users_using_call
    FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
    WHERE DATE(event_ts) = '2023-08-14'
)

SELECT 
    (Users_using_chat + Users_using_call) / CAST(All_users_during_theday AS DECIMAL) AS Overall_user_ratio_using_chatandphone,
    Users_using_chat/ CAST(All_users_during_theday AS DECIMAL) AS User_ratio_using_chat,
    Users_using_call / CAST(All_users_during_theday AS DECIMAL) AS Sser_ratio_using_phone
FROM DailyUsers;

/*3) –ü–æ—Å—á–∏—Ç–∞–π—Ç–µ –¥–æ–ª—é –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∑–∞ –∞–≤–≥—É—Å—Ç, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–≤–µ—Ä—à–∞—é—Ç—Å—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ (—Ç–æ –µ—Å—Ç—å, –≥–æ—Ä–æ–¥ —Å–æ–∏—Å–∫–∞—Ç–µ–ª—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≥–æ—Ä–æ–¥–æ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è).  */
-- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –∑–∞ –∞–≤–≥—É—Å—Ç, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–≤ –ø–æ –¥–Ω—è–º,–≥–æ—Ä–æ–¥—É –ø–æ–∏—Å–∫–∞, –∏ –≥–æ—Ä–æ–¥–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è

SELECT DATE(event_ts) AS day, searcher_city_name, adv_city, COUNT(searcher_uid) AS Users
FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
GROUP BY event_ts,searcher_city_name, adv_city, searcher_uid
HAVING DATE(event_ts) BETWEEN '2023-08-01'AND '2023-08-31'
ORDER BY event_ts ASC
-- –°—É–º–º–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ –¥–Ω—è–º –≤ –∞–≤–≥—É—Å—Ç–µ
SELECT DATE(event_ts) AS day,COUNT(searcher_uid) AS Users
FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
WHERE DATE(event_ts) BETWEEN '2023-08-01' AND '2023-08-31'
GROUP BY day
ORDER BY day ASC;
--13,593,716 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
SELECT COUNT( searcher_uid) AS Users
FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
WHERE DATE(event_ts) BETWEEN '2023-08-01' AND '2023-08-31'

--–ö–∞–∫ –∏ –≤–µ—Ä—Ö–Ω–∏–π –∑–∞–ø—Ä–æ—Å. –ü—Ä–æ—á–µ–ª –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —É –Ω–∞—Å —Ä–æ–≤–Ω–æ –∑–∞ –ê–≤–≥—É—Å—Ç
SELECT COUNT(*) AS all_contacts
FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
-- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –∑–∞ –∞–≤—É–≥—Å—Ç, —É –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ —Ä–∞–≤–Ω—ã–µ –≥–æ—Ä–æ–¥—É –ø–æ–∏—Å–∫–∞ –∏ –≥–æ—Ä–æ–¥—É –æ–±—ä—è–≤–ª–µ–Ω–∏—è = 8,822,679
SELECT SUM(CASE WHEN searcher_city_name != adv_city THEN 1 ELSE 0 END) AS Users_Not_Match
FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`

--–ò—Ç–æ–≥–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞
SELECT SUM(not_match) / COUNT(*) AS Users_City_Not_Match
FROM ( SELECT CASE 
      WHEN ARRAY_LENGTH(SPLIT(searcher_city_name, '/')) < 3 THEN 1
      WHEN SPLIT(searcher_city_name, '/')[OFFSET(2)] != adv_city THEN 1 
      ELSE 0  END AS not_match
  FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`) subquery;

/*4) –†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –≤–æ—Ä–æ–Ω–∫–∏ –∏–∑ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–∏–∑–µ—Ä–∞ –≤ –∫–æ–Ω—Ç–∞–∫—Ç —á–µ—Ä–µ–∑ –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.
üí° –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ:
‚óè	–≤—Å–µ —à–∞–≥–∏ –≤–æ—Ä–æ–Ω–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏ –≤ –æ–¥–∏–Ω –¥–µ–Ω—å,
‚óè	–∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –Ω—É–∂–Ω–æ –æ–∫—Ä—É–≥–ª–∏—Ç—å –¥–æ –¥–µ—Å—è—Ç—ã—Ö.
‚óè	–≤–æ—Ä–æ–Ω–∫—É –Ω—É–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö*/

--Final query
WITH funnel_cte AS (
  SELECT
    DATE(event_ts) AS date,
    cat_1_name,
    searcher_uid,
    COUNT(DISTINCT CASE WHEN event_name = 'viewed_listing' THEN DATE(event_ts) END) AS num_viewed_listing,
    COUNT(DISTINCT CASE WHEN event_name = 'opened_advert_page' THEN DATE(event_ts) END) AS num_opened_advert_page,
    COUNT(DISTINCT CASE WHEN event_name = 'viewed_phone_num' THEN DATE(event_ts) END) AS num_viewed_phone_num,
    COUNT(DISTINCT CASE WHEN event_name = 'opened_chat' THEN DATE(event_ts) END) AS num_opened_chat
  FROM
    `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
  GROUP BY
    date, cat_1_name, searcher_uid
)
SELECT
  date,
  cat_1_name,
  ROUND(AVG(num_opened_advert_page / NULLIF(num_viewed_listing, 0)) * 100, 1) AS conv_viewed_listing_to_opened_advert_page,
  ROUND(AVG(num_viewed_phone_num / NULLIF(num_opened_advert_page, 0)) * 100, 1) AS conv_opened_advert_page_to_viewed_phone_num,
  ROUND(AVG(num_opened_chat / NULLIF(num_opened_advert_page, 0)) * 100, 1) AS conv_opened_advert_page_to_opened_chat
FROM
  funnel_cte
GROUP BY
  date, cat_1_name
ORDER BY date ASC;

/*5) –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ, –∫–∞–∫—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–†–∞–±–æ—Ç–∞, –£—Å–ª—É–≥–∏ –∏ —Ç.–¥.) —á–∞—â–µ –≤—Å–µ–≥–æ –∏—Å–∫–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –∞–≤–≥—É—Å—Ç–µ. –î–ª—è —ç—Ç–æ–≥–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ —á–∞—Å—Ç–æ—Ç–Ω–æ—Å—Ç–∏*/
-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ü–∏—Ñ—Ä–∞–º
SELECT cat_1_name, COUNT (searcher_uid)
FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
GROUP BY cat_1_name

-- Final
WITH categorized_queries AS (
  SELECT
    CASE 
      WHEN cat_1_name = 'uslugi' THEN '–£—Å–ª—É–≥–∏'
      WHEN cat_1_name = 'lichnye-vezchi' THEN '–õ–∏—á–Ω—ã–µ –≤–µ—â–∏'
      WHEN cat_1_name = 'rabota' THEN '–†–∞–±–æ—Ç–∞'
      WHEN cat_1_name = 'dom-dacha' THEN '–î–æ–º –∏ –¥–∞—á–∞'
      WHEN cat_1_name IS NULL THEN '–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'
      WHEN cat_1_name = 'detyam' THEN '–î–µ—Ç—è–º'
      WHEN cat_1_name = 'elektronika' THEN '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞'
      WHEN cat_1_name = 'hobby-otdyh' THEN '–•–æ–±–±–∏ –∏ –æ—Ç–¥—ã—Ö'
      WHEN cat_1_name = 'zhivotnye' THEN '–ñ–∏–≤–æ—Ç–Ω—ã–µ'
      WHEN cat_1_name = 'biznes' THEN '–ë–∏–∑–Ω–µ—Å'
    END AS category
  FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`)

SELECT category, COUNT(*) AS query_count
FROM categorized_queries
GROUP BY category
ORDER BY query_count DESC;

/*–¢–µ–±–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –æ —Ä–∞—Å–∫–∞—Ç–∫–µ –¥–∞–Ω–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –ø–æ –∏—Ç–æ–≥–∞–º –ê/–ë-—Ç–µ—Å—Ç–∞. –ö–∞–∫ —Ç—ã —Å—á–∏—Ç–∞–µ—à—å, —Å—Ç–æ–∏—Ç –ª–∏ –Ω–∞–º –µ–≥–æ —Ä–∞—Å–∫–∞—Ç–∏—Ç—å?
–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø—Ä–∏–Ω—è—Ç—å –≤–æ –≤–Ω–∏–º–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø—É–Ω–∫—Ç—ã:
1.	–£–≤–µ–ª–∏—á–∏–ª–∞—Å—å –ª–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏—è –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –≤–µ—Ç–∫–µ? –ï—Å–ª–∏ –¥–∞, —Ç–æ –Ω–∞—Å–∫–æ–ª—å–∫–æ?
2.	–ú–æ–∂–µ–º –ª–∏ –º—ã –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –æ —Ä–∞—Å–∫–∞—Ç–∫–µ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö? –•–≤–∞—Ç–∞–µ—Ç –ª–∏ –Ω–∞–º –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã –∑–∞–º–µ—Ç–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã–µ —Ä–∞–∑–ª–∏—á–∏—è?
3.	–û—Ç–ª–∏—á–∞—é—Ç—Å—è –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π? –í –∫–∞–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–∞–º–æ–µ –≤—ã—Å–æ–∫–æ–µ –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ?
4.	–û—Ç–ª–∏—á–∞—é—Ç—Å—è –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è –æ–ø—ã—Ç–∞ –ø—Ä–æ—à–ª—ã—Ö –ø–æ–∫—É–ø–æ–∫?
5.	–ï—Å—Ç—å –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –º–æ–∂–µ–º –∑–∞–º–µ—Ä–∏—Ç—å –∏ –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–º –º–æ–≥—É—Ç –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏—Ç–æ–≥–æ–≤?
 */
--–¢–µ—Å—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —É –Ω–∞—Å –∏–º–µ—é—Ç—Å—è
SELECT 
  DATE(event_ts) AS event_date,
  SUM(CASE WHEN fork = 'control' THEN 1 ELSE 0 END) AS fork_control,
  SUM(CASE WHEN fork = 'test' THEN 1 ELSE 0 END) AS fork_test
FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
GROUP BY event_date
ORDER BY event_date ASC;

--1.	–£–≤–µ–ª–∏—á–∏–ª–∞—Å—å –ª–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏—è –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –≤–µ—Ç–∫–µ? –ï—Å–ª–∏ –¥–∞, —Ç–æ –Ω–∞—Å–∫–æ–ª—å–∫–æ?
-- 1) search_results —Ç–∞–±–ª–∏—Ü–µ, –∏—â—É –ø–æ  –¥–≤—É–º –≥—Ä—É–ø–ø–∞–º –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –∫–∞—Ä—Ç–æ—á–∫—É –æ–±—ä—è–≤–ª–µ–Ω–∏—è
-- 2) contact_actions —Ç–∞–±–ª–∏—Ü–µ, —Å—á–∏—Ç–∞—é –ø–æ –¥–≤—É–º –≥—Ä—É–ø–ø–∞–º –¥–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å –¥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
-- 3) control_group —Ç–∞–±–ª–∏—Ü–µ, —Å—É–º–º–∏—Ä—É—é –¥–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å –¥–æ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –¥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
-- 4) test_group —Ç–∞–±–ª–∏—Ü–µ, —Å—É–º–º–∏—Ä—É—é –¥–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å –¥–æ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –¥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
-- 5) –æ–±—ä–µ–¥–µ–Ω—è—é –¥–∞–Ω–Ω—ã–µ –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é –ø–æ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏—é

WITH search_results AS (
  SELECT fork, searcher_uid,
    DATE(event_ts) AS event_date,
    COUNT(DISTINCT CASE WHEN event_name = 'opened_advert_page' THEN searcher_uid END) AS search_results_count
  FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
  WHERE DATE(event_ts) BETWEEN '2023-08-03' AND '2023-08-14'
  GROUP BY fork, searcher_uid, event_date
),

contact_actions AS (
  SELECT fork, searcher_uid,
    COUNT(DISTINCT CASE WHEN event_name IN ('viewed_phone_num', 'opened_chat') THEN searcher_uid END) AS contact_actions_count
  FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
  WHERE event_name IN ('viewed_phone_num', 'opened_chat') AND DATE(event_ts) >= '2023-08-03' AND DATE(event_ts) <= '2023-08-14'
  GROUP BY fork, searcher_uid
),

control_group AS (
  SELECT  search_results.searcher_uid,
    SUM(search_results_count) AS search_results_count,
    SUM(contact_actions_count) AS contact_actions_count
  FROM search_results
  LEFT JOIN contact_actions ON search_results.searcher_uid = contact_actions.searcher_uid AND search_results.fork = contact_actions.fork
  WHERE search_results.fork = 'control'
  GROUP BY search_results.searcher_uid
),

test_group AS (
  SELECT search_results.searcher_uid,
    SUM(search_results_count) AS search_results_count,
    SUM(contact_actions_count) AS contact_actions_count
  FROM search_results
  LEFT JOIN contact_actions ON search_results.searcher_uid = contact_actions.searcher_uid AND search_results.fork = contact_actions.fork
  WHERE search_results.fork = 'test'
  GROUP BY search_results.searcher_uid
)

SELECT 'control' AS group_name,
  SUM(contact_actions_count) / NULLIF(SUM(search_results_count), 0) AS conversion_rate
FROM control_group

UNION ALL

SELECT 'test' AS group_name,
  SUM(contact_actions_count) / NULLIF(SUM(search_results_count), 0) AS conversion_rate
FROM  test_group;
-- –î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
WITH search_results AS (
  SELECT fork, searcher_uid, cat_1_name,
         DATE(event_ts) AS event_date,
         COUNT(DISTINCT CASE WHEN event_name = 'opened_advert_page' THEN searcher_uid END) AS search_results_count
  FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
  WHERE DATE(event_ts) BETWEEN '2023-08-03' AND '2023-08-14'
  GROUP BY fork, searcher_uid, event_date, cat_1_name
),

contact_actions AS (
  SELECT fork, searcher_uid, cat_1_name,
         COUNT(DISTINCT CASE WHEN event_name IN ('viewed_phone_num', 'opened_chat') THEN searcher_uid END) AS contact_actions_count
  FROM `kaspi-mobile.T_KASPI_TEST_DATA.t_kaspi_test_data`
  WHERE event_name IN ('viewed_phone_num', 'opened_chat') AND DATE(event_ts) BETWEEN '2023-08-03' AND '2023-08-14'
  GROUP BY fork, searcher_uid, cat_1_name
),

control_group AS (
  SELECT search_results.cat_1_name,
         SUM(search_results_count) AS search_results_count,
         SUM(contact_actions_count) AS contact_actions_count
  FROM search_results
  LEFT JOIN contact_actions USING (fork, searcher_uid, cat_1_name)
  WHERE search_results.fork = 'control'
  GROUP BY search_results.cat_1_name
),

test_group AS (
  SELECT search_results.cat_1_name,
         SUM(search_results_count) AS search_results_count,
         SUM(contact_actions_count) AS contact_actions_count
  FROM search_results
  LEFT JOIN contact_actions USING (fork, searcher_uid, cat_1_name)
  WHERE search_results.fork = 'test'
  GROUP BY search_results.cat_1_name
)

SELECT 
  'control' AS group_name,
  control_group.cat_1_name,
  SUM(control_group.contact_actions_count) / NULLIF(SUM(control_group.search_results_count), 0) AS conversion_rate
FROM control_group
GROUP BY control_group.cat_1_name

UNION ALL

SELECT
  'test' AS group_name,
  test_group.cat_1_name,
  SUM(test_group.contact_actions_count) / NULLIF(SUM(test_group.search_results_count), 0) AS conversion_rate
FROM test_group
GROUP BY test_group.cat_1_name;
